!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.ASS=e()}(this,function(){"use strict";function t(){this.tree={},this.position=0,this.runline=[],this.scale=1,this._resample="video_height",this.resolution={x:null,y:null},this.container=document.createElement("div"),this.container.className="ASS-container",this.container.appendChild(z),this.container.appendChild(C),this.stage=document.createElement("div"),this.stage.className="ASS-stage ASS-animation-paused"}t.prototype.init=function(t,e,i){if(t&&"VIDEO"===e.nodeName){var s=this;if(!this.video){var n=!e.paused;this.video=e,this.video.parentNode.insertBefore(this.container,this.video),this.container.appendChild(this.video),this.container.appendChild(this.stage),this.video.addEventListener("seeking",function(){s._seek()}),this.video.addEventListener("play",function(){s._play()}),this.video.addEventListener("pause",function(){s._pause()}),n&&this.video.paused&&this.video.play()}this.tree=l(t),this.tree.ScriptInfo.PlayResX&&this.tree.ScriptInfo.PlayResY||(this.tree.ScriptInfo.PlayResX=this.video.videoWidth,this.tree.ScriptInfo.PlayResY=this.video.videoHeight),i&&i.resample&&(this._resample=i.resample);var a=document.getElementById("ASS-style");return a||(a=document.createElement("style"),a.type="text/css",a.id="ASS-style",a.appendChild(document.createTextNode(r)),document.head.appendChild(a)),this.resize(),this}},t.prototype.resize=function(){if(this.video){var t=this.video.clientWidth,e=this.video.clientHeight,i=this.video.videoWidth,s=this.video.videoHeight,n=this.tree.ScriptInfo.PlayResX,a=this.tree.ScriptInfo.PlayResY,r=Math.min(t/i,e/s);this.resolution.x=n,this.resolution.y=a,"video_width"===this.resample&&(this.resolution.y=n/i*s),"video_height"===this.resample&&(this.resolution.x=a/s*i),this.scale=Math.min(t/this.resolution.x,e/this.resolution.y),"script_width"===this.resample&&(this.scale=r*(i/this.resolution.x)),"script_height"===this.resample&&(this.scale=r*(s/this.resolution.y)),this.width=this.scale*this.resolution.x,this.height=this.scale*this.resolution.y;var o="width:"+t+"px;height:"+e+"px;";return this.container.style.cssText=o,o="width:"+this.width+"px;height:"+this.height+"px;top:"+(e-this.height)/2+"px;left:"+(t-this.width)/2+"px;",this.stage.style.cssText=o,C.style.cssText=o,C.setAttributeNS(null,"viewBox",[0,0,n,a].join(" ")),N.call(this),this._seek(),this}},t.prototype.show=function(){return this.stage.style.visibility="visible",this},t.prototype.hide=function(){return this.stage.style.visibility="hidden",this},Object.defineProperty(t.prototype,"resample",{get:function(){var t=this._resample;return"video_width"===t||"video_height"===t||"script_width"===t||"script_height"===t?t:"video_height"},set:function(t){return t===this._resample?t:void("video_width"!==t&&"video_height"!==t&&"script_width"!==t&&"script_height"!==t||(this._resample=t,this.resize()))}}),t.prototype._play=function(){var t=this,i=function(){t._launch(),s=e(i)};s=e(i),this.stage.classList.remove("ASS-animation-paused")},t.prototype._pause=function(){i(s),s=0,this.stage.classList.add("ASS-animation-paused")},t.prototype._seek=function(){for(var t=this.video.currentTime,e=this.tree.Events.Dialogue;this.stage.lastChild;)this.stage.removeChild(this.stage.lastChild);for(;_.lastChild;)_.removeChild(_.lastChild);this.runline=[],n=[],this.position=function(){for(var i=0,s=e.length-1;i+1<s&&t>e[s+i>>1].End;)i=s+i>>1;if(!i)return 0;for(var n=i;n<s;++n)if(e[n].End>t&&t>=e[n].Start||n&&e[n-1].End<t&&t<e[n].Start)return n;return s}(),this._launch()},t.prototype._launch=function(){for(var t=this.video.currentTime,e=this.tree.Events.Dialogue,i=this.runline.length-1;i>=0;--i){var s=this.runline[i],n=s.End;if(s.Effect&&/scroll/.test(s.Effect.name)){var a=(s.Effect.y2-s.Effect.y1)/(1e3/s.Effect.delay);n=Math.min(n,s.Start+a)}n<t&&(this.stage.removeChild(s.node),s.clipPath&&_.removeChild(s.clipPath),this.runline.splice(i,1))}for(;this.position<e.length&&t>=e[this.position].Start;){if(t<e[this.position].End){var s=x.call(this,e[this.position]);this.runline.push(s)}++this.position}};var e=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(t){return setTimeout(t,50/3)},i=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||function(t){clearTimeout(t)},s=0,n=[],a="http://www.w3.org/2000/svg",r=".ASS-container{position:relative;overflow:hidden}.ASS-fix-font-size{position:absolute;visibility:hidden}.ASS-container video{position:absolute;top:0;left:0}.ASS-stage{overflow:hidden;z-index:2147483647;pointer-events:none;position:absolute}.ASS-dialogue{font-size:0;position:absolute}.ASS-fix-objectBoundingBox{width:100%;height:100%;position:absolute;top:0;left:0}.ASS-animation-paused *{-webkit-animation-play-state:paused!important;animation-play-state:paused!important}",o=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0,i="x"===t?e:3&e|8;return i.toString(16)})},l=function(t){t=t.replace(/</g,"&lt;").replace(/>/g,"&gt;");for(var e={ScriptInfo:{Title:"&lt;untitled&gt;","Original Script":"&lt;unknown&gt;"},V4Styles:{Format:{},Style:{}},Events:{Format:{},Dialogue:[]}},i=t.split(/\r?\n/),s=0,n=i.length,a=0;a<n;++a){var r=i[a].replace(/^\s+|\s+$/g,"");if(!/^;/.test(r)&&(/^\[Script Info\]/i.test(r)?s=1:/^\[V4\+ Styles\]/i.test(r)?s=2:/^\[Events\]/i.test(r)?s=3:/^\[.*\]/.test(r)&&(s=0),0!==s)){if(1===s&&/:/.test(r)){var o=r.match(/(.*?)\s*:\s*(.*)/);isNaN(1*o[2])||(o[2]*=1),e.ScriptInfo[o[1]]=o[2]}if(2===s&&(/^Format:/.test(r)&&(e.V4Styles.Format=p(r)),/^Style:/.test(r))){var l=u(r,e);e.V4Styles.Style[l.Name]=l}if(3===s&&(/^Format:/.test(r)&&(e.Events.Format=p(r)),/^Dialogue:/.test(r))){var c=h(r,e);c.Start<c.End&&(c._index=e.Events.Dialogue.length,e.Events.Dialogue.push(c))}}}return e.Events.Dialogue.sort(function(t,e){return t.Start-e.Start||t.End-e.End||t._index-e._index}),e},h=function(t,e){var i=t.match(/Dialogue:(.*)/)[1].split(","),s=e.Events.Format.length;if(i.length>s){var n=i.slice(s-1).join();i=i.slice(0,s-1),i.push(n)}for(var a=e.ScriptInfo.Timer/100||1,r={},o=0;o<s;++o)r[e.Events.Format[o]]=i[o].replace(/^\s+/,"");return r.Layer*=1,r.Start=g(r.Start)/a,r.End=g(r.End)/a,r.Style=e.V4Styles.Style[r.Style]?r.Style:"Default",r.MarginL*=1,r.MarginR*=1,r.MarginV*=1,r.Effect=d(r.Effect),r._parsedText=f(r,e.V4Styles.Style),r},c=function(t){function e(t,e){this.x=t,this.y=e,this.toString=function(){return this.x+","+this.y}}function i(t){this.points=[],this.type=null,this.prevType=null,this.nextType=null,/m/.test(t)&&(this.type="M"),/n|l/.test(t)&&(this.type="L"),/b/.test(t)&&(this.type="C"),/s/.test(t)&&(this.type="_S"),this.isValid=function(){return!(!this.points.length||!this.type)&&!(/C|S/.test(this.type)&&this.points.length<3)},this.toString=function(){return"_S"===this.type?a(this.points,this.prevType,this.nextType):this.type+this.points.join()}}t=t.replace(/([mnlbspc])/gi," $1 ").replace(/^\s*|\s*$/g,"").replace(/\s+/g," ").toLowerCase();for(var s=t.split(/\s(?=[mnlbspc])/),n=[],a=function(t,i,s){var n=[0,2/3,1/3,0],a=[0,1/3,2/3,0],r=[0,1/6,2/3,1/6],o=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]},l=[t[t.length-1].x,t[0].x,t[1].x,t[2].x],h=[t[t.length-1].y,t[0].y,t[1].y,t[2].y],c=["L",new e(o(r,l),o(r,h))];"M"===i&&(c[0]="M");for(var d=3;d<t.length;d++)l=[t[d-3].x,t[d-2].x,t[d-1].x,t[d].x],h=[t[d-3].y,t[d-2].y,t[d-1].y,t[d].y],c.push("C"+new e(o(n,l),o(n,h)),","+new e(o(a,l),o(a,h)),","+new e(o(r,l),o(r,h)));return"L"!==s&&"C"!==s||c.push("L",t[t.length-1]),c.join("")},r=0;r<s.length;){for(var o=s[r].split(" "),l=new i(o[0]),h=o.length-!(1&o.length),c=1;c<h;c+=2)l.points.push(new e(o[c],o[c+1]));if(/p|c/.test(o[0])){if("_S"===n[r-1].type){if("p"===o[0]){var d=n[r-1].points.concat(l.points);n[r-1].points=d}if("c"===o[0]){var p=n[r-1].points;n[r-1].points.push(new e(p[0].x,p[0].y),new e(p[1].x,p[1].y),new e(p[2].x,p[2].y))}}s.splice(r,1)}else{if("s"===o[0]){var d=n[r-1].points[n[r-1].points.length-1];l.points.unshift(new e(d.x,d.y))}l.isValid()&&(r&&(l.prevType=n[r-1].type,n[r-1].nextType=l.type),n.push(l)),r++}}return n},d=function(t){var e=t.toLowerCase().split(";");return"banner"===e[0]?{name:e[0],delay:1*e[1]||1,lefttoright:1*e[2]||0,fadeawaywidth:1*e[3]||0}:/^scroll\s/.test(e[0])?{name:e[0],y1:Math.min(e[1],e[2]),y2:Math.max(e[1],e[2]),delay:1*e[3]||1,fadeawayheight:1*e[4]||0}:null},p=function(t){return t.match(/Format:(.*)/)[1].replace(/\s/g,"").split(",")},u=function(t,e){for(var i=t.match(/Style:(.*)/)[1].split(","),s={},n=i.length-1;n>=0;--n){var a=e.V4Styles.Format[n];s[a]=i[n].replace(/^\s*/,""),isNaN(1*s[a])||(s[a]*=1)}return s._tags={fn:s.Fontname,fs:s.Fontsize,c1:s.PrimaryColour.match(/&H(\w\w)?(\w{6})&?/)[2],a1:s.PrimaryColour.match(/&H(\w\w)?(\w{6})&?/)[1]||"00",c2:s.SecondaryColour.match(/&H(\w\w)?(\w{6})&?/)[2],a2:s.SecondaryColour.match(/&H(\w\w)?(\w{6})&?/)[1]||"00",c3:s.OutlineColour.match(/&H(\w\w)?(\w{6})&?/)[2],a3:s.OutlineColour.match(/&H(\w\w)?(\w{6})&?/)[1]||"00",c4:s.BackColour.match(/&H(\w\w)?(\w{6})&?/)[2],a4:s.BackColour.match(/&H(\w\w)?(\w{6})&?/)[1]||"00",b:Math.abs(s.Bold),i:Math.abs(s.Italic),u:Math.abs(s.Underline),s:Math.abs(s.StrikeOut),q:e.ScriptInfo.WrapStyle||1,fscx:s.ScaleX,fscy:s.ScaleY,fsp:s.Spacing,frz:s.Angle,xbord:s.Outline,ybord:s.Outline,xshad:s.Shadow,yshad:s.Shadow},s},f=function(t,e){var i=t.Text.replace(/\\N/g,"<br>").replace(/\\h/g,"&nbsp;"),s=JSON.parse(JSON.stringify(e[t.Style]._tags)),n=i.split(/{([^{}]*?)}/),a={content:[]};n[0].length&&a.content.push({text:n[0],tags:s});for(var r=1;r<n.length;r+=2){for(var o={text:n[r+1],tags:JSON.parse(JSON.stringify(s))},l=n[r].split("\\"),h=0;h<l.length;++h)if(/^t\(/.test(l[h])&&!/\)$/.test(l[h])){for(;!/\)$/.test(l[h+1]);)l[h]+="\\"+l[h+1],l.splice(h+1,1);l[h]+="\\"+l[h+1],l.splice(h+1,1)}for(var h=0;h<l.length;++h){var d=l[h];if(m.call(o,d),o.tags.clip&&(a.clip=o.tags.clip),/^b\d/.test(d)&&(o.tags.b=1*d.match(/^b(\d+)/)[1]),/^i\d/.test(d)&&(o.tags.i=1*d[1]),/^u\d/.test(d)&&(o.tags.u=1*d[1]),/^s\d/.test(d)&&(o.tags.s=1*d[1]),/^fn/.test(d)&&(o.tags.fn=d.match(/^fn(.*)/)[1]),/^fe/.test(d)&&(o.tags.fe=1*d.match(/^fe(.*)/)[1]),/^k\d/.test(d)&&(o.tags.k=1*d.match(/^k(\d+)/)[1]),/^K\d/.test(d)&&(o.tags.kf=1*d.match(/^K(\d+)/)[1]),/^kf\d/.test(d)&&(o.tags.kf=1*d.match(/^kf(\d+)/)[1]),/^ko\d/.test(d)&&(o.tags.ko=1*d.match(/^ko(\d+)/)[1]),/^kt\d/.test(d)&&(o.tags.kt=1*d.match(/^kt(\d+)/)[1]),/^q\d/.test(d)&&(o.tags.q=1*d[1]),/^p\d/.test(d)&&(o.tags.p=1*d.match(/^p(\d+)/)[1]),/^pbo/.test(d)&&(o.tags.pbo=1*d.match(/^pbo(.*)/)[1]),/^an\d/.test(d)&&!a.alignment&&(a.alignment=1*d[2]),/^a\d/.test(d)&&!a.alignment){var p=1*d.match(/^a(\d+)/)[1];p<4?a.alignment=p:p>8?a.alignment=p-5:a.alignment=p+2}if(/^pos/.test(d)&&!a.pos&&!a.move){var u=d.replace(/\s/g,"").match(/^pos\((.*?)\)?$/)[1].split(",");a.pos={x:1*u[0],y:1*u[1]}}if(/^org/.test(d)&&!a.org){var u=d.replace(/\s/g,"").match(/^org\((.*?)\)?$/)[1].split(",");a.org={x:1*u[0],y:1*u[1]}}if(/^move/.test(d)&&!a.move&&!a.pos){var u=d.replace(/\s/g,"").match(/^move\((.*?)\)?$/)[1].split(",").map(function(t){return 1*t});a.pos={x:1*u[0],y:1*u[1]},4===u.length&&(u.push(0),u.push(1e3*(t.End-t.Start))),a.move=u}if(/^fad\s*\(/.test(d)&&!a.fad&&(a.fad=d.replace(/\s/g,"").match(/^fad\((.*?)\)?$/)[1].split(",").map(function(t){return 1*t})),/^fade/.test(d)&&!a.fade&&(a.fade=d.replace(/\s/g,"").match(/^fade\((.*?)\)?$/)[1].split(",").map(function(t){return 1*t})),/^r/.test(d)){var f=d.match(/^r(.*)/)[1],g=e[f]||e[t.Style];o.tags=JSON.parse(JSON.stringify(g._tags))}if(/^t\(/.test(d)){var x=d.replace(/\s/g,"").match(/^t\((.*)\)/)[1].split(",");if(!x[0])continue;for(var v=x[x.length-1].split("\\"),y={t1:0,t2:1e3*(t.End-t.Start),accel:1,tags:{}},S=v.length-1;S>=0;S--)m.call(y,v[S]);2===x.length&&(y.accel=1*x[0]),3===x.length&&(y.t1=1*x[0],y.t2=1*x[1]),4===x.length&&(y.t1=1*x[0],y.t2=1*x[1],y.accel=1*x[2]),o.tags.t||(o.tags.t=[]),o.tags.t.push(y)}}if(o.tags.t)for(var h=0;h<o.tags.t.length-1;++h)for(var S=h+1;S<o.tags.t.length;++S)if(o.tags.t[h].t1===o.tags.t[S].t1&&o.tags.t[h].t2===o.tags.t[S].t2){for(var b in o.tags.t[S].tags)o.tags.t[h].tags[b]=o.tags.t[S].tags[b];o.tags.t.splice(S,1)}t.Effect&&"banner"===t.Effect.name&&(o.tags.q=2),o.tags.p?o.commands=c(o.text):o.text=o.text.replace(/\s/g,"&nbsp;"),o.text=o.text.replace(/\\n/g,2===o.tags.q?"<br>":"&nbsp;"),s=o.tags,a.content.push(o)}return a},m=function(t){if(/^fs[\d\+\-]/.test(t)){var e=t.match(/^fs(.*)/)[1];/^\d/.test(e)&&(this.tags.fs=1*e),/^\+|-/.test(e)&&(this.tags.fs*=1*e>-10?1+e/10:1)}if(/^fsp/.test(t)&&(this.tags.fsp=1*t.match(/^fsp(.*)/)[1]),/^fscx/.test(t)&&(this.tags.fscx=1*t.match(/^fscx(.*)/)[1]),/^fscy/.test(t)&&(this.tags.fscy=1*t.match(/^fscy(.*)/)[1]),/^fsp/.test(t)&&(this.tags.fsp=1*t.match(/^fsp(.*)/)[1]),/^frx/.test(t)&&(this.tags.frx=1*t.match(/^frx(.*)/)[1]),/^fry/.test(t)&&(this.tags.fry=1*t.match(/^fry(.*)/)[1]),/^fr[z\d\-]/.test(t)&&(this.tags.frz=1*t.match(/^frz?(.*)/)[1]),/^blur\d/.test(t)&&(this.tags.blur=1*t.match(/^blur(.*)/)[1]),/^be\d/.test(t)&&(this.tags.blur=1*t.match(/^be(.*)/)[1]),this.tags.blur<0&&(this.tags.blur=0),/^fax/.test(t)&&(this.tags.fax=1*t.match(/^fax(.*)/)[1]),/^fay/.test(t)&&(this.tags.fay=1*t.match(/^fay(.*)/)[1]),/^x*bord/.test(t)&&(this.tags.xbord=1*t.match(/^x*bord(.*)/)[1]),/^y*bord/.test(t)&&(this.tags.ybord=1*t.match(/^y*bord(.*)/)[1]),this.tags.xbord<0&&(this.tags.xbord=0),this.tags.ybord<0&&(this.tags.ybord=0),/^x*shad/.test(t)&&(this.tags.xshad=1*t.match(/^x*shad(.*)/)[1]),/^y*shad/.test(t)&&(this.tags.yshad=1*t.match(/^y*shad(.*)/)[1]),/^\d?c&?H?[0-9a-f]+/i.test(t)){var i=t.match(/^(\d?)c&?H?(\w+)/);for(i[1]||(i[1]="1");i[2].length<6;)i[2]="0"+i[2];this.tags["c"+i[1]]=i[2]}if(/^\da&?H?[0-9a-f]+/i.test(t)){var i=t.match(/^(\d)a&?H?(\w\w)/);this.tags["a"+i[1]]=i[2]}if(/^alpha&?H?[0-9a-f]+/i.test(t))for(var s=1;s<=4;s++)this.tags["a"+s]=t.match(/^alpha&?H?(\w\w)/)[1];if(/^i?clip/.test(t)){var n=t.match(/^i?clip\s*\((.*)\)/)[1].split(/\s*,\s*/);this.tags.clip={inverse:/iclip/.test(t),scale:1,commands:null,dots:null},1===n.length&&(this.tags.clip.commands=c(n[0])),2===n.length&&(this.tags.clip.scale=1*n[0],this.tags.clip.commands=c(n[1])),4===n.length&&(this.tags.clip.dots=[1*n[0],1*n[1],1*n[2],1*n[3]])}},g=function(t){var e=t.split(":");return 3600*e[0]+60*e[1]+1*e[2]},x=function(t){var e=t._parsedText,i=this.tree.V4Styles.Style[t.Style],s={node:document.createElement("div"),Alignment:e.alignment||i.Alignment,Layer:t.Layer,Start:t.Start,End:t.End,BorderStyle:i.BorderStyle,MarginL:t.MarginL||i.MarginL,MarginR:t.MarginR||i.MarginR,MarginV:t.MarginV||i.MarginV,Effect:t.Effect,parsedText:e,animationName:e.animationName,move:e.move,fad:e.fad,fade:e.fade,pos:e.pos||(e.move?{x:0,y:0}:null),org:e.org,clip:e.clip,channel:0,t:!1};s.node.className="ASS-dialogue",v.call(this,s),this.stage.appendChild(s.node);var n=s.node.getBoundingClientRect();return s.width=n.width,s.height=n.height,y.call(this,s),S.call(this,s),b(s),w.call(this,s),s},v=function(t){for(var e=document.createDocumentFragment(),i=t.parsedText.content.length,s=0;s<i;++s){var n=t.parsedText.content[s];if(n.text){var a=n.tags,r=["display:inline-block"],o=this.video.currentTime;if(!a.p){r.push("font-family:'"+a.fn+"',Arial");var l=this.scale*B(a.fs,a.fn);r.push("font-size:"+l+"px"),r.push("color:"+R(a.a1+a.c1));var h=this.tree.ScriptInfo.ScaledBorderAndShadow,c=/Yes/i.test(h)?this.scale:1;1===t.BorderStyle&&r.push("text-shadow:"+M(a,c)),3===t.BorderStyle&&(r.push("background-color:"+R(a.a3+a.c3)),r.push("box-shadow:"+M(a,c))),0===a.b?r.push("font-weight:normal"):1===a.b?r.push("font-weight:bold"):r.push("font-weight:"+a.b),r.push("font-style:"+(a.i?"italic":"normal")),a.u&&a.s?r.push("text-decoration:underline line-through"):a.u?r.push("text-decoration:underline"):a.s&&r.push("text-decoration:line-through"),r.push("letter-spacing:"+this.scale*a.fsp+"px"),0===a.q,1===a.q&&(r.push("word-break:break-all"),r.push("word-break:break-word"),r.push("white-space:normal")),2===a.q&&(r.push("word-break:normal"),r.push("word-break:break-word"),r.push("white-space:nowrap")),3===a.q}if(a.fax||a.fay||a.frx||a.fry||a.frz||100!==a.fscx||100!==a.fscy){var d=V(a);["","-webkit-"].forEach(function(t){r.push(t+"transform:"+d)}),a.p||(r.push("transform-style:preserve-3d"),r.push("word-break:normal"),r.push("word-break:break-word"),r.push("white-space:nowrap"))}a.t&&(["","-webkit-"].forEach(function(e){var i=Math.min(0,t.Start-o);r.push(e+"animation-name:"+n.animationName),r.push(e+"animation-duration:"+(t.End-t.Start)+"s"),r.push(e+"animation-delay:"+i+"s"),r.push(e+"animation-timing-function:linear"),r.push(e+"animation-iteration-count:1"),r.push(e+"animation-fill-mode:forwards")}),t.t=!0),t.hasRotate=/"fr[xyz]":[^0]/.test(JSON.stringify(a));for(var p=n.text.split("<br>"),u=p.length,f=0;f<u;f++)if(f&&e.appendChild(document.createElement("br")),p[f]){var m=document.createElement("span");if(m.dataset.hasRotate=t.hasRotate,a.p){if(m.appendChild(L.call(this,m,n,t)),a.pbo){var g=this.scale*-a.pbo*(a.fscy||100)/100;r.push("vertical-align:"+g+"px")}}else m.innerHTML=p[f];m.style.cssText+=r.join(";"),e.appendChild(m)}}}t.node.appendChild(e)},y=function(t){t.Effect?("banner"===t.Effect.name&&(t.Alignment<=3&&(t.y=this.height-t.height-t.MarginV),t.Alignment>=4&&t.Alignment<=6&&(t.y=(this.height-t.height)/2),t.Alignment>=7&&(t.y=t.MarginV),t.Effect.lefttoright?t.x=-t.width:t.x=this.width),/^scroll/.test(t.Effect.name)&&(t.y=/up/.test(t.Effect.name)?this.height:-t.height,t.Alignment%3===1&&(t.x=0),t.Alignment%3===2&&(t.x=(this.width-t.width)/2),t.Alignment%3===0&&(t.x=this.width-t.width))):t.pos?(t.Alignment%3===1&&(t.x=this.scale*t.pos.x),t.Alignment%3===2&&(t.x=this.scale*t.pos.x-t.width/2),t.Alignment%3===0&&(t.x=this.scale*t.pos.x-t.width),t.Alignment<=3&&(t.y=this.scale*t.pos.y-t.height),t.Alignment>=4&&t.Alignment<=6&&(t.y=this.scale*t.pos.y-t.height/2),t.Alignment>=7&&(t.y=this.scale*t.pos.y)):(t.Alignment%3===1&&(t.x=0),t.Alignment%3===2&&(t.x=(this.width-t.width)/2),t.Alignment%3===0&&(t.x=this.width-t.width-this.scale*t.MarginR),t.t?(t.Alignment<=3&&(t.y=this.height-t.height-t.MarginV),t.Alignment>=4&&t.Alignment<=6&&(t.y=(this.height-t.height)/2),t.Alignment>=7&&(t.y=t.MarginV)):t.y=T.call(this,t))},S=function(t){var e=[],i=this.video.currentTime;if(t.Layer&&e.push("z-index:"+t.Layer),(t.move||t.fad||t.fade||t.Effect)&&["","-webkit-"].forEach(function(s){e.push(s+"animation-name:"+t.animationName),e.push(s+"animation-duration:"+(t.End-t.Start)+"s"),e.push(s+"animation-delay:"+Math.min(0,t.Start-i)+"s"),e.push(s+"animation-timing-function:linear"),e.push(s+"animation-iteration-count:1"),e.push(s+"animation-fill-mode:forwards")}),t.Alignment%3===1&&e.push("text-align:left"),t.Alignment%3===2&&e.push("text-align:center"),t.Alignment%3===0&&e.push("text-align:right"),!t.Effect){var s=this.width-this.scale*(t.MarginL+t.MarginR);e.push("max-width:"+s+"px"),t.pos||(t.Alignment%3===1&&e.push("margin-left:"+this.scale*t.MarginL+"px"),t.Alignment%3===0&&e.push("margin-right:"+this.scale*t.MarginR+"px"),t.width>this.width-this.scale*(t.MarginL+t.MarginR)&&(e.push("margin-left:"+this.scale*t.MarginL+"px"),e.push("margin-right:"+this.scale*t.MarginR+"px")))}e.push("width:"+t.width+"px"),e.push("height:"+t.height+"px"),e.push("left:"+t.x+"px"),e.push("top:"+t.y+"px"),t.node.style.cssText=e.join(";")},b=function(t){if(t.hasRotate){t.org||(t.org={x:0,y:0},t.Alignment%3===1&&(t.org.x=t.x),t.Alignment%3===2&&(t.org.x=t.x+t.width/2),t.Alignment%3===0&&(t.org.x=t.x+t.width),t.Alignment<=3&&(t.org.y=t.y+t.height),t.Alignment>=4&&t.Alignment<=6&&(t.org.y=t.y+t.height/2),t.Alignment>=7&&(t.org.y=t.y));for(var e=t.node.childNodes,i=e.length-1;i>=0;i--)if(e[i].dataset.hasRotate){var s=t.org.x-t.x-e[i].offsetLeft,n=t.org.y-t.y-e[i].offsetTop,a="transform-origin:"+s+"px "+n+"px;";e[i].style.cssText+="-webkit-"+a+a}}},w=function(t){if(t.clip){var e=document.createElement("div");this.stage.insertBefore(e,t.node),e.appendChild(t.node),t.node=e,e.className="ASS-fix-objectBoundingBox",e.style.cssText+=k.call(this,t)}},A=document.createElement("style");A.type="text/css",A.className="ASS-animation",document.head.appendChild(A);var N=function(){function t(){this.obj={},this.set=function(t,e,i){this.obj[t]||(this.obj[t]={}),this.obj[t][e]=i},this.toString=function(){var t=["{"];for(var e in this.obj){t.push(e+"{");for(var i in this.obj[e]){var s=i+":"+this.obj[e][i]+";";"transform"===i&&t.push("-webkit-"+s),t.push(s)}t.push("}")}return t.push("}\n"),t.join("")}}for(var e={},i=function(t){for(var i in e)if(e[i]===t)return i;return null},s=this.tree.Events.Dialogue.length-1;s>=0;s--){var n=this.tree.Events.Dialogue[s],a=n._parsedText,r=1e3*(n.End-n.Start),l=new t,h="",c=[];if(n.Effect&&!a.move){var d=n.Effect;if("banner"===d.name){var p=this.scale*(r/d.delay)*(d.lefttoright?1:-1);l.set("0.000%","transform","translateX(0)"),l.set("100.000%","transform","translateX("+p+"px)")}if(/^scroll/.test(d.name)){var u=/up/.test(d.name)?-1:1,f=d.y1,m=d.y2||this.resolution.y,g="translateY("+this.scale*f*u+"px)",x="translateY("+this.scale*m*u+"px)",v=(m-f)/(r/d.delay)*100;c[1]=Math.min(100,v).toFixed(3)+"%",l.set("0.000%","transform",g),l.set(c[1],"transform",x),l.set("100.000%","transform",x)}}if(!a.fad&&a.fade&&2===a.fade.length&&(a.fad=a.fade),a.fad&&2===a.fad.length&&(c[0]="0.000%",c[1]=Math.min(100,a.fad[0]/r*100).toFixed(3)+"%",c[2]=Math.max(0,(r-a.fad[1])/r*100).toFixed(3)+"%",c[3]="100.000%",l.set(c[0],"opacity",0),l.set(c[1],"opacity",1),l.set(c[2],"opacity",1),l.set(c[3],"opacity",0)),a.fade&&7===a.fade.length){c[0]="0.000%",c[5]="100.000%";for(var y=1;y<=4;y++)c[y]=Math.min(100,a.fade[y+2]/r*100).toFixed(3)+"%";for(var y=0;y<=5;y++)l.set(c[y],"opacity",1-a.fade[y>>1]/255)}if(a.move&&6===a.move.length&&(a.pos||(a.pos={x:0,y:0}),6===a.move.length)){c[0]="0.000%",c[1]=Math.min(100,a.move[4]/r*100).toFixed(3)+"%",c[2]=Math.min(100,a.move[5]/r*100).toFixed(3)+"%",c[3]="100.000%";for(var y=0;y<=3;y++){var p=this.scale*(a.move[y<2?0:2]-a.pos.x),S=this.scale*(a.move[y<2?1:3]-a.pos.y);l.set(c[y],"transform","translate("+p+"px, "+S+"px)")}}h=l.toString();var b=i(h);null===b&&(b="ASS-"+o(),e[b]=h),a.animationName=b;for(var y=a.content.length-1;y>=0;y--){l=new t;var w=JSON.parse(JSON.stringify(a.content[y].tags));if(w.t)for(var N=w.t.length-1;N>=0;N--){var E=JSON.parse(JSON.stringify(w.t[N].tags));if(c[0]="0.000%",c[1]=Math.min(100,w.t[N].t1/r*100).toFixed(3)+"%",c[2]=Math.min(100,w.t[N].t2/r*100).toFixed(3)+"%",c[3]="100.000%",E.fs){var C=this.scale*B(w.fs,w.fn)+"px",_=this.scale*B(E.fs,w.fn)+"px";l.set(c[0],"font-size",C),l.set(c[1],"font-size",C),l.set(c[2],"font-size",_),l.set(c[3],"font-size",_)}if(E.fsp){var k=this.scale*w.fsp+"px",T=this.scale*E.fsp+"px";l.set(c[0],"letter-spacing",k),l.set(c[1],"letter-spacing",k),l.set(c[2],"letter-spacing",T),l.set(c[3],"letter-spacing",T)}if(E.c1||E.a1){E.c1=E.c1||w.c1,E.a1=E.a1||w.a1;var L=R(w.a1+w.c1),F=R(E.a1+E.c1);l.set(c[0],"color",L),l.set(c[1],"color",L),l.set(c[2],"color",F),l.set(c[3],"color",F)}if(E.a1&&E.a1===E.a2&&E.a2===E.a3&&E.a3===E.a4){var j=1-parseInt(w.a1,16)/255,z=1-parseInt(E.a1,16)/255;l.set(c[0],"opacity",j),l.set(c[1],"opacity",j),l.set(c[2],"opacity",z),l.set(c[3],"opacity",z)}var I=["c3","a3","c4","a4","xbord","ybord","xshad","yshad","blur"],O=function(t){for(var e=I.length-1;e>=0;--e)if(void 0!==t[I[e]])return!0;return!1};if(O(E)){I.forEach(function(t){void 0===E[t]&&(E[t]=w[t])});var H=this.tree.ScriptInfo.ScaledBorderAndShadow,P=/Yes/i.test(H)?this.scale:1,D=M(w,P),Y=M(E,P);l.set(c[0],"text-shadow",D),l.set(c[1],"text-shadow",D),l.set(c[2],"text-shadow",Y),l.set(c[3],"text-shadow",Y)}if(E.fscx&&100!==E.fscx||E.fscy&&100!==E.fscy||void 0!==E.frx||void 0!==E.fry||void 0!==E.frz||void 0!==E.fax||void 0!==E.fay){var X=["fscx","fscy","frx","fry","frz","fax","fay"];X.forEach(function(t){void 0===E[t]&&(E[t]=w[t])}),w.p&&(E.fscx=E.fscx/w.fscx*100,E.fscy=E.fscy/w.fscy*100,w.fscx=w.fscy=100);var g=V(w),x=V(E);l.set(c[0],"transform",g),l.set(c[1],"transform",g),l.set(c[2],"transform",x),l.set(c[3],"transform",x)}}h=l.toString();var b=i(h);null===b&&(b="ASS-"+o(),e[b]=h),a.content[y].animationName=b}}var q=[];for(var b in e)q.push("@keyframes "+b+e[b]),q.push("@-webkit-keyframes "+b+e[b]);A.innerHTML=q.join("")},E=function(t,e,i){var s=t.xbord||t.ybord,n=t.xshad||t.yshad,r="FF"===t.a1,o=t.blur||0,l=document.createElementNS(a,"filter");l.setAttributeNS(null,"id",e);var h=document.createElementNS(a,"feGaussianBlur");h.setAttributeNS(null,"stdDeviation",s?0:o),h.setAttributeNS(null,"in","SourceGraphic"),h.setAttributeNS(null,"result","sg_b"),l.appendChild(h);var c=document.createElementNS(a,"feFlood");c.setAttributeNS(null,"flood-color",R(t.a1+t.c1)),c.setAttributeNS(null,"result","c1"),l.appendChild(c);var d=document.createElementNS(a,"feComposite");if(d.setAttributeNS(null,"operator","in"),d.setAttributeNS(null,"in","c1"),d.setAttributeNS(null,"in2","sg_b"),d.setAttributeNS(null,"result","main"),l.appendChild(d),s){var p=document.createElementNS(a,"feMorphology");p.setAttributeNS(null,"radius",t.xbord*i+" "+t.ybord*i),p.setAttributeNS(null,"operator","dilate"),p.setAttributeNS(null,"in","SourceGraphic"),p.setAttributeNS(null,"result","dil"),l.appendChild(p);var u=document.createElementNS(a,"feGaussianBlur");u.setAttributeNS(null,"stdDeviation",o),u.setAttributeNS(null,"in","dil"),u.setAttributeNS(null,"result","dil_b"),l.appendChild(u);var f=document.createElementNS(a,"feComposite");f.setAttributeNS(null,"operator","out"),f.setAttributeNS(null,"in","dil_b"),f.setAttributeNS(null,"in2","SourceGraphic"),f.setAttributeNS(null,"result","dil_b_o"),l.appendChild(f);var m=document.createElementNS(a,"feFlood");m.setAttributeNS(null,"flood-color",R(t.a3+t.c3)),m.setAttributeNS(null,"result","c3"),l.appendChild(m);var g=document.createElementNS(a,"feComposite");g.setAttributeNS(null,"operator","in"),g.setAttributeNS(null,"in","c3"),g.setAttributeNS(null,"in2","dil_b_o"),g.setAttributeNS(null,"result","border"),l.appendChild(g)}if(n&&(s||!r)){var x=document.createElementNS(a,"feOffset");x.setAttributeNS(null,"dx",t.xshad*i),x.setAttributeNS(null,"dy",t.yshad*i),x.setAttributeNS(null,"in",s?"dil":"SourceGraphic"),x.setAttributeNS(null,"result","off"),l.appendChild(x);var v=document.createElementNS(a,"feGaussianBlur");if(v.setAttributeNS(null,"stdDeviation",o),v.setAttributeNS(null,"in","off"),v.setAttributeNS(null,"result","off_b"),l.appendChild(v),r){var y=document.createElementNS(a,"feOffset");y.setAttributeNS(null,"dx",t.xshad*i),y.setAttributeNS(null,"dy",t.yshad*i),y.setAttributeNS(null,"in","SourceGraphic"),y.setAttributeNS(null,"result","sg_off"),l.appendChild(y);var S=document.createElementNS(a,"feComposite");S.setAttributeNS(null,"operator","out"),S.setAttributeNS(null,"in","off_b"),S.setAttributeNS(null,"in2","sg_off"),S.setAttributeNS(null,"result","off_b_o"),l.appendChild(S)}var b=document.createElementNS(a,"feFlood");b.setAttributeNS(null,"flood-color",R(t.a4+t.c4)),b.setAttributeNS(null,"result","c4"),l.appendChild(b);var w=document.createElementNS(a,"feComposite");w.setAttributeNS(null,"operator","in"),w.setAttributeNS(null,"in","c4"),w.setAttributeNS(null,"in2",r?"off_b_o":"off_b"),w.setAttributeNS(null,"result","shadow"),l.appendChild(w)}var A=document.createElementNS(a,"feMerge");if(n&&(s||!r)){var N=document.createElementNS(a,"feMergeNode");N.setAttributeNS(null,"in","shadow"),A.appendChild(N)}if(s){var E=document.createElementNS(a,"feMergeNode");E.setAttributeNS(null,"in","border"),A.appendChild(E)}var M=document.createElementNS(a,"feMergeNode");return M.setAttributeNS(null,"in","main"),A.appendChild(M),l.appendChild(A),l},M=function(t,e){var i=[],s=R(t.a3+t.c3),n=t.xbord*e,a=t.ybord*e,r=R(t.a4+t.c4),o=t.xshad*e,l=t.yshad*e,h=t.blur||0;if(!(n+a+o+l))return"none";if(n||a)for(var c=-1;c<=1;c++)for(var d=-1;d<=1;d++){for(var p=1;p<n;p++)for(var u=1;u<a;u++)(c||d)&&i.push(s+" "+c*p+"px "+d*u+"px "+h+"px");i.push(s+" "+c*n+"px "+d*a+"px "+h+"px")}if(o||l){var f=o>0?1:-1,m=l>0?1:-1;o=Math.abs(o),l=Math.abs(l);for(var p=Math.max(n,o-n);p<o+n;p++)for(var u=Math.max(a,l-a);u<l+a;u++)i.push(r+" "+p*f+"px "+u*m+"px "+h+"px");i.push(r+" "+(o+n)*f+"px "+(l+a)*m+"px "+h+"px")}return i.join()},C=document.createElementNS(a,"svg");C.setAttributeNS(null,"class","ASS-clip-path");var _=document.createElementNS(a,"defs");C.appendChild(_);var k=function(t){if(t.clip){var e="",i="ASS-"+o(),s=1/(1<<t.clip.scale-1),n=this.tree.ScriptInfo.PlayResX,r=this.tree.ScriptInfo.PlayResY;if(null!==t.clip.dots){var l=t.clip.dots.map(function(t,e){return 1&e?t/r:t/n});e+="M"+[l[0],l[1]].join(),e+="L"+[l[0],l[3],l[2],l[3],l[2],l[1]].join()+"Z"}null!==t.clip.commands&&(e=F(t.clip.commands,n,r).d),t.clip.inverse&&(e+="M0,0L"+[0,s,s,s,s,0,0,0].join()+"Z"),t.clipPath=document.createElementNS(a,"clipPath"),t.clipPath.setAttributeNS(null,"id",i),t.clipPath.setAttributeNS(null,"clipPathUnits","objectBoundingBox");var h=document.createElementNS(a,"path");h.setAttributeNS(null,"d",e),h.setAttributeNS(null,"transform","scale("+s+")"),h.setAttributeNS(null,"clip-rule","evenodd"),t.clipPath.appendChild(h),_.appendChild(t.clipPath);var c="clip-path:url(#"+i+");";return"-webkit-"+c+c}return""},T=function(t){var e=t.Layer,i=this.width-Math.floor(this.scale*(t.MarginL+t.MarginR)),s=this.height,a=t.width,r=t.height,o=Math.floor(this.scale*t.MarginV),l=this.video.currentTime,h=0;n[e]=n[e]||{left:new Uint16Array(s+1),center:new Uint16Array(s+1),right:new Uint16Array(s+1),leftEnd:new Uint32Array(s+1),centerEnd:new Uint32Array(s+1),rightEnd:new Uint32Array(s+1)};var c=["right","left","center"][t.Alignment%3],d=function(t){var s=n[e].left[t],r=n[e].center[t],o=n[e].right[t],h=n[e].leftEnd[t]/100,d=n[e].centerEnd[t]/100,p=n[e].rightEnd[t]/100;return!("left"!==c||!(h>l&&s||d>l&&r&&2*a+r>i||p>l&&o&&a+o>i))||(!("center"!==c||!(h>l&&s&&2*s+a>i||d>l&&r||p>l&&o&&2*o+a>i))||!("right"!==c||!(h>l&&s&&s+a>i||d>l&&r&&2*a+r>i||p>l&&o)))},p=function(e){return d(e)?h=0:h++,h>=r&&(t.channel=e,!0)};if(t.Alignment<=3)for(var u=s-o-1;u>o&&!p(u);u--);else if(t.Alignment>=7)for(var u=o+1;u<s-o&&!p(u);u++);else for(var u=s-r>>1;u<s-o&&!p(u);u++);t.Alignment>3&&(t.channel-=r-1);for(var u=t.channel;u<t.channel+r;u++)n[e][c][u]=a,n[e][c+"End"][u]=100*t.End;return t.channel},L=function(t,e,i){var s=e.tags,n=this.scale/(1<<s.p-1),r=(s.fscx?s.fscx/100:1)*n,l=(s.fscy?s.fscy/100:1)*n,h=F(e.commands),c=[h.minX,h.minY,h.width,h.height].join(" "),d="ASS-"+o(),p="ASS-"+o(),u=this.tree.ScriptInfo.ScaledBorderAndShadow,f=/Yes/i.test(u)?this.scale:1,m="http://www.w3.org/1999/xlink",g=s.blur||0,x=s.xbord+(s.xshad<0?-s.xshad:0)+g,v=s.ybord+(s.yshad<0?-s.yshad:0)+g,y=h.width*r+2*s.xbord+Math.abs(s.xshad)+2*g,S=h.height*r+2*s.ybord+Math.abs(s.yshad)+2*g,b=document.createElementNS(a,"svg");b.setAttributeNS(null,"width",y),b.setAttributeNS(null,"height",S),b.setAttributeNS(null,"viewBox",[-x,-v,y,S].join(" "));var w=document.createElementNS(a,"defs");w.appendChild(E(s,d,f)),b.appendChild(w);var A=document.createElementNS(a,"symbol");A.setAttributeNS(null,"id",p),A.setAttributeNS(null,"viewBox",c),b.appendChild(A);var N=document.createElementNS(a,"path");N.setAttributeNS(null,"d",h.d),A.appendChild(N);var M=document.createElementNS(a,"use");return M.setAttributeNS(null,"width",h.width*r),M.setAttributeNS(null,"height",h.height*l),M.setAttributeNS(m,"xlink:href","#"+p),M.setAttributeNS(null,"filter","url(#"+d+")"),b.appendChild(M),t.style.cssText+="position:relative;width:"+h.width*r+"px;height:"+h.height*l+"px;",b.style.cssText="position:absolute;left:"+(h.minX*r-x)+"px;top:"+(h.minY*l-v)+"px;",b},F=function(t,e,i){e=e||1,i=i||1;for(var s=Number.MAX_VALUE,n=Number.MAX_VALUE,a=Number.MIN_VALUE,r=Number.MIN_VALUE,o=[],l=t.length,h=0;h<l;h++)t[h].points.forEach(function(t){s=Math.min(s,t.x),n=Math.min(n,t.y),a=Math.max(a,t.x),r=Math.max(r,t.y),t.x/=e,t.y/=i}),o.push(t[h].toString()),t[h].points.forEach(function(t){
t.x*=e,t.y*=i});return{d:o.join("")+"Z",minX:s,minY:n,width:a-s,height:r-n}},j={},z=document.createElement("div");z.className="ASS-fix-font-size",z.textContent="M";var B=function(t,e){var i=e+"-"+t;if(!j[i]){var s="font-size:"+t+"px;font-family:'"+e+"',Arial;";z.style.cssText=s,j[i]=t*t/z.clientHeight}return j[i]},R=function(t){var e=t.match(/(\w\w)(\w\w)(\w\w)(\w\w)/),i=1-("0x"+e[1])/255,s=+("0x"+e[2]),n=+("0x"+e[3]),a=+("0x"+e[4]);return"rgba("+[a,n,s,i].join()+")"},V=function(t){var e=[];return e.push("perspective(314px)"),e.push("rotateY("+(t.fry||0)+"deg)"),e.push("rotateX("+(t.frx||0)+"deg)"),e.push("rotateZ("+(-t.frz||0)+"deg)"),e.push("scale("+(t.p?1:(t.fscx||100)/100)+","+(t.p?1:(t.fscy||100)/100)+")"),e.push("skew("+(t.fax||0)+"rad,"+(t.fay||0)+"rad)"),e.join(" ")};return t});